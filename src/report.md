# Сети в Linux

## **Part 1. Инструмент ipcalc**

### **1.1. Сети и маски**

Определить и записать в отчет:

- Адрес сети 192.167.38.54/13:
```
    - 192.160.0.0
```

- Перевод маски:
```
    - 255.255.255.0
        - префиксная запись: /24
        - двоичная запись: 11111111.11111111.11111111.00000000
    - /15
        - обычная запись: 255.254.0.0
        - двоичная запись: 11111111.11111111.00000000.00000000
    - 11111111.11111111.11111111.11110000
        - обычная запись: 255.255.255.240
        - префиксная запись: /28
```

- Минимальный и максимальный хост в сети 12.167.38.4 при масках:
```
    - /8:
    min - 12.0.0.1
    max - 12.255.255.254

    - 11111111.11111111.00000000.00000000:
    min - 12.167.0.1
    max - 12.167.255.254

    - 255.255.254.0:
    min - 12.167.38.1
    max - 12.167.39.254

    - /4:
    min - 0.0.0.1
    max - 15.255.255.254
```
### **1.2. localhost**

Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP:
```
- 127.0.0.2 - да (Loopback)
- 127.1.0.1 - да (Loopback)
- 128.0.0.1 - нет (Without loopback)
- 194.34.23.100 - нет (Without loopback)

    Loopback — адрес определяется протоколом TCP/IP как зарезервированный адрес, который направляет пакеты обратно к узлу.
```
### **1.3. Диапазоны и сегменты сетей**

Определить и записать в отчёт:

- Какие из перечисленных ip можно использовать в качестве публичных, а какие в качестве частных:
```
    - 10.0.0.45 - приватный
    - 192.168.4.2 - приватный
    - 172.20.250.4 - приватный
    - 172.16.255.255 - приватный
    - 10.10.10.10 - приватный

    - 134.43.0.2 - публичный
    - 172.0.2.1 - публичный
    - 192.172.0.1 - публичный
    - 172.68.0.2 - публичный
    - 192.169.168.1 - публичный
```
- Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:
```
    - 10.10.0.2 - да
    - 10.10.10.10 - да
    - 10.0.0.1 - нет
    - 10.10.100.1 - нет
    - 10.10.1.255 - нет
```
## Part 2. Статическая маршрутизация между двумя машинами

С помощью команды ip a посмотреть посмотреть существующие сетевые интерфейсы

![linux_network](/src/img/ipa1.png)
![linux_network](/src/img/ipa2.png)

Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

![linux_network](/src/img/netplan1.png)
![linux_network](/src/img/netplan2.png)

Выполнить команду netplan apply для перезапуска сервиса сети

![linux_network](/src/img/apply1.png)
![linux_network](/src/img/apply2.png)

### 2.1. Добавление статического маршрута вручную

Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add.
Пропинговать соединение между машинами.

![linux_network](/src/img/ipr1.png)
![linux_network](/src/img/ipr2.png)

### 2.2. Добавление статического маршрута с сохранением

Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml

![linux_network](/src/img/netplan3.png)
![linux_network](/src/img/netplan4.png)

Пропинговать соединение между машинами

![linux_network](/src/img/ping1_1.png)
![linux_network](/src/img/ping1_2.png)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

Перевести и записать в отчёт:
```
- 8 Mbps в MB/s : 64 MB/s
(Умножьте значение "Скорость Передачи Данных" на 8)

- 100 MB/s в Kbps : 800000 Kbps
(Умножьте значение "Скорость Передачи Данных" на 8000)

- 1 Gbps в Mbps : 1000 Mbps
(Умножьте значение "Скорость Передачи Данных" на 1000)
```
### 3.2. Утилита iperf3

![linux_network](/src/img/iperf3_1.png)
![linux_network](/src/img/iperf3_2.png)

## Part 4. Сетевой экран

### 4.1. Утилита iptables 

Создать файл /etc/firewall.sh, имитирующий фаерволл

- на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (касается пунктов 4 и 5)
- на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (касается пунктов 4 и 5)
- открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
- запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
- разрешить *echo reply* (машина должна "пинговаться")

![linux_network](/src/img/iptables_1.png)
![linux_network](/src/img/iptables_2.png)

Использовать команды chmod +x /etc/firewall.sh и /etc/firewall.sh для запуска скриптов.

![linux_network](/src/img/chmod_1.png)
![linux_network](/src/img/chmod_2.png)
```
Если запрещающее правило стоит первым, то следующее разрешающее правило не будет работать.
```
### 4.2. Утилита nmap
```
        Nmap («Network Mapper») — утилита с открытым исходным кодом для исследования сети и проверки безопасности. 
        Была разработана для быстрого сканирования больших сетей, хотя хорошо справляется и с единичными целями. Nmap использует сырые IP пакеты оригинальными способами, чтобы определить какие хосты доступны в сети, какие службы (название приложения и версию) они предлагают, какие операционные системы (и версии ОS) они используют, какие типы пакетных фильтров брандмауэров используются и еще множество других характеристик. 
        В то время как Nmap обычно используется для проверки безопасности, множество сетевых и системных администраторов находят ее полезной и для обычных задач, таких как контролирование структуры сети, управление расписаниями запуска служб и учет времени работы хоста или службы.
```
![linux_network](/src/img/ping2_1.png)
![linux_network](/src/img/ping2_2.png)

## Part 5. Статическая маршрутизация сети

### 5.1. Настройка адресов машин
```
Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке ↑↑↑.
```
- w11

![linux_network](/src/img/netplan5.png)

- w21

![linux_network](/src/img/netplan6.png)

- w22

![linux_network](/src/img/netplan7.png)

- r2

![linux_network](/src/img/netplan8.png)

- r1

![linux_network](/src/img/netplan9.png)
```
Команда netplan apply проверит config на наличие ошибок и применит его в случае успеха. 
Если ошибок нет, то командой <ip -4 a> (IPv4) нужно проверить, что адрес машины задан верно.
```
![linux_network](/src/img/n_apply_1.png)
![linux_network](/src/img/n_apply_2.png)
![linux_network](/src/img/n_apply_3.png)
![linux_network](/src/img/n_apply_4.png)
![linux_network](/src/img/n_apply_5.png)

Пропинговать ws22 с ws21 и r1 с ws11.
![linux_network](/src/img/ping_3_1.png)
![linux_network](/src/img/ping_3_2.png)

### 5.2. Включение переадресации IP-адресов.

Для включения переадресации IP, выполнить команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1` 
![linux_network](/src/img/sysctl_1.png)
![linux_network](/src/img/sysctl_2.png)

IP-переадресация включена на постоянной основе.
![linux_network](/src/img/ipforward_1.png)
![linux_network](/src/img/ipforward_2.png)

### 5.3. Установка маршрута по-умолчанию
```
Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 ip роутера в файле конфигураций.
```
- w11

![linux_network](/src/img/netplan10.png)

- w21

![linux_network](/src/img/netplan11.png)

- w22

![linux_network](/src/img/netplan12.png)

Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации.
![linux_network](/src/img/appl1.png)
![linux_network](/src/img/appl2.png)
![linux_network](/src/img/appl3.png)

Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i eth1`
![linux_network](/src/img/ping_4_1.png)
![linux_network](/src/img/ping_4_2.png)

### 5.4. Добавление статических маршрутов

Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
![linux_network](/src/img/netplan13.png)
![linux_network](/src/img/netplan14.png)

Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах.
![linux_network](/src/img/iprr_1.png)
![linux_network](/src/img/iprr_2.png)

Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`
![linux_network](/src/img/iprl_1.png)
```
Маршрут подбирается по таблице марштрутизаторов. 
Если маршрут выбран успешно, то он будет передан. 
Если не успешно — пакет не будет передан. 
Если несколько совпадений, то для переадресации будет выбран маршрут с самой длинной маской.
```
### 5.5. Построение списка маршрутизаторов

Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`
![linux_network](/src/img/tcpdump_1.png)

При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
![linux_network](/src/img/traceroute_1.png)
![linux_network](/src/img/icml.png)
```
    Каждый пакет проходит определенное количество узлов, пока достигнет своей цели. 
    Каждый пакет активен ограниченное время.
    Активность пакета — количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. 
    Этот параметр записывается в заголовке TTL. Каждый маршрутизатор, через который будет проходить пакет, уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение «Time Exceeded».

    Команда <<traceroute linux>> использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита <traceroute> получает сообщение от целевого узла о том, что порт недоступен, трассировка считается завершенной.
```
### 5.6. Использование протокола ICMP при маршрутизации

Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
![linux_network](/src/img/ping_5_2.png)
Пропинговать с ws11 несуществующий IP с помощью команды `ping`
![linux_network](/src/img/ping_5_1.png)

## Part 6. Динамическая настройка IP с помощью DHCP

Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**.

Указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
![linux_network](/src/img/dhcp1_1.png)
В файле *resolv.conf* прописать `nameserver 8.8.8.8.`
![linux_network](/src/img/resolv1_1.png)
Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`.
![linux_network](/src/img/sysctl_3.png)

Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.
![linux_network](/src/img/ipaa.png)
![linux_network](/src/img/ping6_1.png)

Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

![linux_network](/src/img/ntplan_1.png)

Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

![linux_network](/src/img/dhcp2_1.png)
![linux_network](/src/img/range1_1.png)
![linux_network](/src/img/name1_1.png)
ip до обновления и после.
![linux_network](/src/img/ipaa1_1.png)
![linux_network](/src/img/ipaa1_2.png)

Запросить с ws21 обновление ip адреса
![linux_network](/src/img/ipaa2_1.png)
Пинг с обновленным ip у машины ws21
![linux_network](/src/img/ping7_1.png)
```
Опции DHCP сервера, использованные в данном пункте:

Option 1 — маска подсети IP
Option 3 — основной шлюз
Option 6 — адрес сервера DNS (основной и резервный)
```

## Part 7. **NAT**
```
- В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, другими словами сделать сервер Apache2 общедоступным.

- Запустить веб-сервер Apache командой service apache2 start на ws22 и r1.
```
![linux_network](/src/img/ports1_1.png)
![linux_network](/src/img/ports1_2.png)

Добавить в фаервол, на r2 следующие правила:
```
- Удалить правила в таблице filter - iptables -F
- Удалить правила в таблице "NAT" - iptables -F -t nat
- Отбросить все маршрутизируемые пакеты - iptables --policy FORWARD DROP
```
![linux_network](/src/img/iptables2_1.png)
![linux_network](/src/img/chmod2_1.png)

Проверить соединение между ws22 и r1 командой `ping`

![linux_network](/src/img/ping8_1.png)

Добавить в файл ещё одно правило:
- Разрешить маршрутизацию всех пакетов протокола **ICMP**
![linux_network](/src/img/chmod3_1.png)

Проверить соединение между ws22 и r1 командой `ping`
![linux_network](/src/img/ping9_1.png)

Добавить в файл ещё два правила:
- Включить **SNAT** — маскирование всех локальных ip из локальной сети, находящейся за r2 (Из части 5 - сеть 10.20.0.0).
- Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.
![linux_network](/src/img/frwall1_1.png)

Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1.
![linux_network](/src/img/telnet1_1.png)

Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` 
![linux_network](/src/img/telnet1_2.png)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

Запустить веб-сервер **Apache** на ws22 только на localhost (в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)

![linux_network](/src/img/ports3_1.png)

Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![linux_network](/src/img/lhost1_1.png)
![linux_network](/src/img/lhost1_2.png)


![linux_network](/src/img/lhost1_3.png)
![linux_network](/src/img/lhost1_4.png)
